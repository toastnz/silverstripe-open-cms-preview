{"version":3,"file":"index.js","mappings":"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","sources":["webpack://open-cms-preview/./client/source/scripts/index.js"],"sourcesContent":["function _typeof(o) { \"@babel/helpers - typeof\"; return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (o) { return typeof o; } : function (o) { return o && \"function\" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? \"symbol\" : typeof o; }, _typeof(o); }\nfunction _classCallCheck(a, n) { if (!(a instanceof n)) throw new TypeError(\"Cannot call a class as a function\"); }\nfunction _defineProperties(e, r) { for (var t = 0; t < r.length; t++) { var o = r[t]; o.enumerable = o.enumerable || !1, o.configurable = !0, \"value\" in o && (o.writable = !0), Object.defineProperty(e, _toPropertyKey(o.key), o); } }\nfunction _createClass(e, r, t) { return r && _defineProperties(e.prototype, r), t && _defineProperties(e, t), Object.defineProperty(e, \"prototype\", { writable: !1 }), e; }\nfunction _toPropertyKey(t) { var i = _toPrimitive(t, \"string\"); return \"symbol\" == _typeof(i) ? i : i + \"\"; }\nfunction _toPrimitive(t, r) { if (\"object\" != _typeof(t) || !t) return t; var e = t[Symbol.toPrimitive]; if (void 0 !== e) { var i = e.call(t, r || \"default\"); if (\"object\" != _typeof(i)) return i; throw new TypeError(\"@@toPrimitive must return a primitive value.\"); } return (\"string\" === r ? String : Number)(t); }\nimport '../styles/index.scss';\nvar CMSPreviewController = /*#__PURE__*/function () {\n  function CMSPreviewController() {\n    _classCallCheck(this, CMSPreviewController);\n    this.defaultSrc = 'about:blank?CMSPreview=1';\n    this.previewPanel = document.createElement('div');\n    this.input = null;\n    this.container = null;\n    this.refreshTimeout = null;\n    this.refreshDelay = 100;\n    this.isRefreshing = false;\n    this.iframe = document.createElement('iframe');\n    this.cache = {};\n    this.selectors = {\n      container: '.cms-container',\n      input: '[name=\"OpenCMSPreview\"]'\n    };\n    this.events = {};\n    this.init();\n  }\n  return _createClass(CMSPreviewController, [{\n    key: \"init\",\n    value: function init() {\n      this.setupIframe();\n      this.setupObserver();\n      this.makePreviewResizeable();\n    }\n  }, {\n    key: \"setupIframe\",\n    value: function setupIframe() {\n      this.iframe.src = this.defaultSrc;\n      this.iframe.className = 'open-cms-preview__iframe';\n      this.previewPanel.classList.add('open-cms-preview');\n      this.previewPanel.appendChild(this.iframe);\n    }\n  }, {\n    key: \"refresh\",\n    value: function refresh() {\n      var _this = this;\n      var event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      if (this.isRefreshing) return;\n      var prevent = false;\n\n      // Halve the delay time because we wait twice\n      var delay = this.refreshDelay * 0.5;\n\n      // Wrap the event in a new object\n      event = {\n        data: event\n      };\n\n      // Add a prevent refresh function to the event object\n      event.preventRefresh = function () {\n        return prevent = true;\n      };\n      this.callback('beforeRefresh', event);\n      if (prevent) return;\n      clearTimeout(this.refreshTimeout);\n      this.isRefreshing = true;\n      this.refreshTimeout = setTimeout(function () {\n        clearTimeout(_this.refreshTimeout);\n        _this.iframe.src = _this.defaultSrc;\n        _this.iframe.classList.add('loading');\n        _this.refreshTimeout = setTimeout(function () {\n          if (!_this.input) return _this.isRefreshing = false;\n          var _onLoad = function onLoad() {\n            _this.isRefreshing = false;\n            _this.iframe.removeEventListener('load', _onLoad);\n            _this.iframe.classList.remove('loading');\n            _this.callback('refresh', _this.input.value);\n          };\n          _this.iframe.addEventListener('load', _onLoad);\n          _this.iframe.src = _this.input.value;\n        }, delay);\n      }, delay);\n    }\n  }, {\n    key: \"addPreview\",\n    value: function addPreview() {\n      if (!document.body.contains(this.previewPanel)) {\n        this.container.appendChild(this.previewPanel);\n        this.refresh();\n        this.callback('addPreview', this.previewPanel);\n      }\n    }\n  }, {\n    key: \"removePreview\",\n    value: function removePreview() {\n      if (document.body.contains(this.previewPanel)) {\n        this.previewPanel.remove();\n        this.callback('removePreview');\n      }\n    }\n  }, {\n    key: \"setupObserver\",\n    value: function setupObserver() {\n      var _this2 = this;\n      var observer = new MutationObserver(function () {\n        _this2.input = document.querySelector(_this2.selectors.input);\n        _this2.container = document.querySelector(_this2.selectors.container);\n        if (_this2.input && _this2.container) {\n          if (_this2.cache.input && _this2.input === _this2.cache.input && _this2.cache.container && _this2.container === _this2.cache.container) return;\n          _this2.cache.input = _this2.input;\n          _this2.cache.container = _this2.container;\n          _this2.addPreview();\n        } else {\n          _this2.removePreview();\n        }\n      });\n      observer.observe(document.body, {\n        childList: true,\n        subtree: true\n      });\n    }\n  }, {\n    key: \"makePreviewResizeable\",\n    value: function makePreviewResizeable() {\n      var _this3 = this;\n      var isDragging = false;\n      var thumb = document.createElement('button');\n      thumb.classList.add('open-cms-preview__thumb');\n      this.previewPanel.appendChild(thumb);\n      thumb.addEventListener('mousedown', function () {\n        isDragging = true;\n        _this3.previewPanel.classList.add('dragging');\n      });\n      window.addEventListener('mouseup', function () {\n        isDragging = false;\n        _this3.previewPanel.classList.remove('dragging');\n      });\n      window.addEventListener('mousemove', function (e) {\n        window.requestAnimationFrame(function () {\n          if (!isDragging) return;\n          var mouseX = e.clientX - 10;\n          var width = window.innerWidth - mouseX;\n          document.body.style.setProperty('--preview-width', \"\".concat(width, \"px\"));\n        });\n      });\n    }\n  }, {\n    key: \"callback\",\n    value: function callback(type) {\n      var data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      // run the callback functions\n      if (this.events[type]) this.events[type].forEach(function (event) {\n        return event(data);\n      });\n    }\n  }, {\n    key: \"on\",\n    value: function on(event, func) {\n      // If we loaded an event and it's not the on event and we also loaded a function\n      if (event && event != 'on' && event != 'callback' && func && typeof func == 'function') {\n        if (this.events[event] == undefined) this.events[event] = [];\n        // Push a new event to the event array\n        this.events[event].push(func);\n      }\n    }\n  }]);\n}(); // Create a new instance of the CMSPreviewController and assign it to the window\nwindow.OpenCMSPreviewController = new CMSPreviewController();\n\n// Some default conditions to prevent refresh\nvar shouldPreventRefresh = function shouldPreventRefresh(URL, response) {\n  if (!URL) return false;\n\n  // URL based conditions\n  if (!URL.pathname.startsWith('/admin')) return true;\n  if (URL.pathname.endsWith('/search')) return true;\n  if (URL.pathname.endsWith('/ping')) return true;\n  if (URL.pathname.endsWith('/SearchForm')) return true;\n  if (URL.searchParams.has('search')) return true;\n\n  // If this is a reorder request, allow the refresh regardless of the response\n  if (URL.pathname.endsWith('/reorder')) return false;\n  if (!response) return false;\n\n  // Response based conditions\n  try {\n    // Try parse the response as JSON, if it fails, prevent refresh\n    var contentType = response.getResponseHeader(\"Content-Type\");\n    if (contentType && contentType !== 'application/json') return true;\n  } catch (error) {/* Do nothing */}\n  return false;\n};\n\n// Before the refresh event, check if we should prevent the refresh\nwindow.OpenCMSPreviewController.on('beforeRefresh', function (event) {\n  var _event$data = event.data,\n    URL = _event$data.URL,\n    response = _event$data.response;\n  if (shouldPreventRefresh(URL, response)) return event.preventRefresh();\n});\n\n// After any fetch event, call the refresh method\nfunction onAfterFetch() {\n  var path = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';\n  var response = arguments.length > 1 ? arguments[1] : undefined;\n  if (!path.startsWith('/')) path = '/' + path;\n  var locationURL = new URL(window.location.href);\n  var postURL = new URL(locationURL.origin + path);\n  window.OpenCMSPreviewController.refresh({\n    URL: postURL,\n    response: response\n  });\n}\n(function () {\n  var originalOpen = XMLHttpRequest.prototype.open;\n  var originalSend = XMLHttpRequest.prototype.send;\n  XMLHttpRequest.prototype.open = function (method, url) {\n    this._url = url;\n    originalOpen.apply(this, arguments);\n  };\n  XMLHttpRequest.prototype.send = function () {\n    var _this4 = this;\n    this.addEventListener('load', function () {\n      return onAfterFetch(_this4._url, _this4);\n    });\n    originalSend.apply(this, arguments);\n  };\n})();"],"names":["_typeof","o","Symbol","iterator","constructor","prototype","_defineProperties","e","r","t","length","enumerable","configurable","writable","Object","defineProperty","i","toPrimitive","String","Number","call","TypeError","key","originalOpen","originalSend","CMSPreviewController","this","defaultSrc","previewPanel","document","createElement","input","container","refreshTimeout","refreshDelay","isRefreshing","iframe","cache","selectors","events","init","value","setupIframe","setupObserver","makePreviewResizeable","src","className","classList","add","appendChild","prevent","delay","_this","event","arguments","undefined","callback","data","clearTimeout","setTimeout","_onLoad","removeEventListener","remove","addEventListener","body","contains","refresh","_this2","MutationObserver","querySelector","addPreview","removePreview","observe","childList","subtree","_this3","isDragging","thumb","window","requestAnimationFrame","width","mouseX","clientX","innerWidth","style","setProperty","concat","type","forEach","func","push","OpenCMSPreviewController","on","_event$data","URL","response","pathname","startsWith","endsWith","searchParams","has","contentType","getResponseHeader","error","preventRefresh","XMLHttpRequest","open","send","method","url","_url","apply","_this4","path","locationURL","location","href","postURL","origin"],"sourceRoot":""}