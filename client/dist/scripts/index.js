(()=>{window.OpenCMSPreviewController=new class{constructor(){this.defaultSrc="about:blank?CMSPreview=1",this.previewPanel=document.createElement("div"),this.input=null,this.container=null,this.refreshTimeout=null,this.refreshDelay=100,this.isRefreshing=!1,this.iframe=document.createElement("iframe"),this.cache={},this.selectors={container:".cms-container",input:'[name="OpenCMSPreview"]'},this.events={},this.init()}init(){this.setupIframe(),this.setupObserver(),this.makePreviewResizeable()}setupIframe(){this.iframe.src=this.defaultSrc,this.iframe.className="open-cms-preview__iframe",this.previewPanel.classList.add("open-cms-preview"),this.previewPanel.appendChild(this.iframe)}refresh(i={}){if(!this.isRefreshing){let e=!1,t=.5*this.refreshDelay;this.callback("beforeRefresh",i={data:i,preventRefresh:()=>e=!0}),e||(clearTimeout(this.refreshTimeout),this.isRefreshing=!0,this.refreshTimeout=setTimeout(()=>{clearTimeout(this.refreshTimeout),this.iframe.src=this.defaultSrc,this.iframe.classList.add("loading"),this.refreshTimeout=setTimeout(()=>{if(!this.input)return this.isRefreshing=!1;let e=()=>{this.isRefreshing=!1,this.iframe.removeEventListener("load",e),this.iframe.classList.remove("loading"),this.callback("refresh",this.input.value)};this.iframe.addEventListener("load",e),this.iframe.src=this.input.value},t)},t))}}addPreview(){document.body.contains(this.previewPanel)||(this.container.appendChild(this.previewPanel),this.refresh(),this.callback("addPreview",this.previewPanel))}removePreview(){document.body.contains(this.previewPanel)&&(this.previewPanel.remove(),this.callback("removePreview"))}setupObserver(){new MutationObserver(()=>{this.input=document.querySelector(this.selectors.input),this.container=document.querySelector(this.selectors.container),this.input&&this.container?this.cache.input&&this.input===this.cache.input&&this.cache.container&&this.container===this.cache.container||(this.cache.input=this.input,this.cache.container=this.container,this.addPreview()):this.removePreview()}).observe(document.body,{childList:!0,subtree:!0})}makePreviewResizeable(){let i=!1,s=0;var e=parseInt(window.sessionStorage.getItem("cmsPreviewWidth")||0,10),t=document.createElement("button");t.classList.add("open-cms-preview__thumb"),this.previewPanel.appendChild(t),e&&document.body.style.setProperty("--preview-width",e+"px"),t.addEventListener("mousedown",()=>{i=!0,this.previewPanel.classList.add("dragging")}),window.addEventListener("mouseup",()=>{i=!1,this.previewPanel.classList.remove("dragging"),window.sessionStorage.setItem("cmsPreviewWidth",s+"px")}),window.addEventListener("mousemove",t=>{window.requestAnimationFrame(()=>{var e;i&&(e=t.clientX-10,s=window.innerWidth-e,document.body.style.setProperty("--preview-width",s+"px"))})})}callback(e,t=!1){this.events[e]&&this.events[e].forEach(e=>e(t))}on(e,t){e&&"on"!=e&&"callback"!=e&&t&&"function"==typeof t&&(null==this.events[e]&&(this.events[e]=[]),this.events[e].push(t))}};window.OpenCMSPreviewController.on("beforeRefresh",e=>{var t=e.data.URL;if((e=>{if(e){if(!e.pathname.startsWith("/admin"))return!0;if(e.pathname.endsWith("/search"))return!0;if(e.pathname.endsWith("/ping"))return!0;if(e.pathname.endsWith("/SearchForm"))return!0;if(e.searchParams.has("search"))return!0;e.pathname.endsWith("/reorder")}return!1})(t))return e.preventRefresh()});{let i=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,t){this._url=t,i.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){this.addEventListener("load",()=>{var e,t,i;[e="",t]=[this._url,this],e.startsWith("/")||(e="/"+e),i=new URL(window.location.href),i=new URL(i.origin+e),window.OpenCMSPreviewController.refresh({URL:i,response:t})}),e.apply(this,arguments)}}})();